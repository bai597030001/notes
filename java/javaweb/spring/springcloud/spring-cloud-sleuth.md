# sleuth

`Spring Cloud Sleuth` 的主要功能就是为 **分布式系统** 提供 **追踪解决方案**，并且兼容支持了 `Zipkin`，只需要在 `pom.xml` 文件中引入相应的 **依赖** 即可。本文主要讲述 **服务追踪组件** `Zipkin`，`Spring Cloud Sleuth` 集成了 `Zipkin` 组件。它主要用于 **聚集** 来自各个 **异构系统** 的 **实时监控数据**，用来追踪 **微服务架构** 下的 **系统延时问题**。



## 相关术语

### 1.1. Span

`Span` 是一个基本的 **工作单元**，用于描述一次 `RPC` 调用，`Span` 通过一个 `64` 位的 `spanId` 作为 **唯一标识**。`Zipkin` 中的 `Span` 还有其他数据信息，比如 **摘要**、**时间戳事件**、**关键值注释** (`tags`) 以及 **进度** `ID` (通常是 `IP` 地址)。`Span` 在不断的启动和停止，同时记录了 **时间信息**，一个 `Span` 创建后，必须在未来的某个时刻停止它。

### 1.2. Trace

一系列 `Span` 组成的一个 **树状结构**。例如，如果你正在跑一个大型 **分布式系统**，可能需要创建一个 `Trace`。

### 1.3. Annotation

表示 **基本标注列表**，一个 `Annotation` 可以理解成 `Span` 生命周期中 **重要时刻** 的 **数据快照**，比如一个 `Annotation` 中一般包含 **发生时刻**（`timestamp`）、**事件类型**（`value`）、**端点**（`endpoint`）等信息。其中 `Annotation` 的 **事件类型** 包含以下四类：

- **cs - Client Sent**

**客户端** 发起一个请求，这个 `Annotion` 描述了这个 `Span` 的开始。

- **sr - Server Received**

**服务端** 获得请求并 **准备开始** 处理它，如果将 `sr` 减去 `cs` 的 **时间戳** 便可得到 **网络延迟**。

- **ss - Server Sent**

**服务端** 完成请求处理，如果将 `ss` 减去 `sr` 的 **时间戳**，便可得到 **服务端** 处理请求消耗的时间。

- **cr - Client Received**

**客户端** 成功接收到 **服务端** 的响应，如果将 `cr` 减去 `cs` 的 **时间戳**，便可得到 **整个请求** 所消耗的 **总时间**。



# zipkin

Zipkin是一个致力于收集分布式服务的时间数据的分布式跟踪系统。其主要涉及以下四个组件：

-  **collector:** 数据采集;
-  **storage:** 数据存储;
-  **search:** 数据查询;
-  **UI:** 数据展示.

Zipkin提供了可插拔数据存储方式：In-Memory、MySql、Cassandra以及Elasticsearch。